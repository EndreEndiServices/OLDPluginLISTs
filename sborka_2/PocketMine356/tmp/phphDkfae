name: AntiSpam_Final
main: Mafia\AntiSpam\AntiSpam
version: 0.2
author: Mafia
api: [1.7.0]
load: POSTWORLD
permissions:
 chatdefender:
  default: op
  description: ChatDefender top level
  children:
   chatdefender.exempt:
    default: op
    description: Exempt from all blocks
    children:
      chatdefender.exempt.similar:
        default: op
        description: Exempt from similarity checking
      chatdefender.exempt.rate:
        default: op
        description: Exempt from rate limit
<?php
namespace Mafia\AntiSpam;
use pocketmine\event\Listener;
use pocketmine\event\player\PlayerChatEvent;
use pocketmine\event\player\PlayerCommandPreprocessEvent;
use pocketmine\event\player\PlayerQuitEvent;
use pocketmine\plugin\PluginBase;
use pocketmine\utils\Config;

class AntiSpam extends PluginBase implements Listener{
    /** @var  ChatSession[] */
    public $sessions;
    public function onEnable(){
        $this->saveDefaultConfig();
        $this->getServer()->getPluginManager()->registerEvents($this, $this);
        $this->s = [];
    }
    public function onChat(PlayerChatEvent $event){
        if(!isset($this->sessions[$event->getPlayer()->getName()])){
            $this->sessions[$event->getPlayer()->getName()] = new ChatSession($this);
            $this->sessions[$event->getPlayer()->getName()]->bindToPlayer($event->getPlayer());
        }
        if(!$this->sessions[$event->getPlayer()->getName()]->sendMessage($event->getMessage())){
            $event->setCancelled();
        }
    }
    public function onQuit(PlayerQuitEvent $event){
        if(isset($this->sessions[$event->getPlayer()->getName()])) unset($this->sessions[$event->getPlayer()->getName()]);
    }
    public function onCommandPreProcess(PlayerCommandPreprocessEvent $event){
        if($this->getConfig()->get("blockme") && isset($this->sessions[$event->getPlayer()->getName()]) && $this->sessions[$event->getPlayer()->getName()]->isBlocked()){
            $args = explode(" ", $event->getMessage());
            if($args[0] == "/me"){
                $event->setCancelled();
            }
        }
    }
}
